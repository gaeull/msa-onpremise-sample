name: MSA PR CI Pipeline

on:
  pull_request:
    branches: [ main ]

jobs:

  #########################################
  # üü° 1) Î≥ÄÍ≤Ω ÌååÏùº ÌÉêÏßÄ Job
  #########################################
  detect_changes:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.diff.outputs.changed_files }}
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0   # PR diffÎ•º ÏúÑÌï¥ Î∞òÎìúÏãú full fetch ÌïÑÏöî

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      - name: Determine changed files (PR diff)
        id: diff
        run: |
          FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "changed_files=$FILES" >> $GITHUB_OUTPUT

          echo "üîç Changed files:"
          echo "$FILES"


  #########################################
  # üîµ API-GATEWAY
  #########################################
  api_gateway:
    needs: detect_changes
    if: contains(needs.detect_changes.outputs.changed_files, 'api-gateway/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - run: chmod +x api-gateway/gradlew

      - name: Build API Gateway
        working-directory: ./api-gateway
        run: ./gradlew clean build


  #########################################
  # üîµ PRODUCT SERVICE
  #########################################
  product_service:
    needs: detect_changes
    if: contains(needs.detect_changes.outputs.changed_files, 'product-service/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - run: chmod +x product-service/gradlew

      - name: Build Product Service
        working-directory: ./product-service
        run: ./gradlew clean build


  #########################################
  # üîµ ORDER SERVICE
  #########################################
  order_service:
    needs: detect_changes
    if: contains(needs.detect_changes.outputs.changed_files, 'order-service/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - run: chmod +x order-service/gradlew

      - name: Build Order Service
        working-directory: ./order-service
        run: ./gradlew clean build


  #########################################
  # üîµ USER SERVICE
  #########################################
  user_service:
    needs: detect_changes
    if: contains(needs.detect_changes.outputs.changed_files, 'user-service/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - run: chmod +x user-service/gradlew

      - name: Build User Service
        working-directory: ./user-service
        run: ./gradlew clean build


  #########################################
  # üîµ CONFIG SERVER
  #########################################
  config_server:
    needs: detect_changes
    if: contains(needs.detect_changes.outputs.changed_files, 'config-server/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Config Server
        working-directory: ./config-server
        run: ./gradlew clean build


  #########################################
  # üîµ DISCOVERY SERVER
  #########################################
  discovery_server:
    needs: detect_changes
    if: contains(needs.detect_changes.outputs.changed_files, 'discovery-server/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build Discovery Server
        working-directory: ./discovery-server
        run: ./gradlew clean build
